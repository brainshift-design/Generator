<html>
    <script src="core/lib.js"></script>
    <script src="core/math.js"></script>
    <script src="core/util.js"></script>
    <script src="core/random.js"></script>
    <script src="core/base32.js"></script>
    <script src="core/base64.js"></script>
    <script src="core/common.js"></script>
    <script src="core/bigmath.js"></script>
    <script src="license/crypto.js"></script>
    <script src="license/license.js"></script>


    <body>
        <div>User ID  <input type='text' id='txtUserId' spellcheck='false' /></div>
        <div>Tier (0 = free, 1 = std) <input type='text' id='txtTier' spellcheck='false' /></div>
        <div>Last date (ddmmyyyy) <input type='text' id='txtLastDate' spellcheck='false' /></div>
        <input type='button' onclick='generateLicenseKey()' value='Generate license key' />
        <p id='text' style="margin-top: 30px"></p>
    </body>

    <style>
        body
        {
            font:          11pt Consolas;
            overflow-wrap: break-word;
            word-break:    break-all;
            line-height:   1.5em;
        }
    </style>

    <script>

        function generateLicenseKey()
        {
            let txt = '';


            let userId   = getQueryVariable('userId' );
            let tier     = getQueryVariable('tier'   );
            let lastDate = getQueryVariable('lastDate'); // DDMMYYYY (UTC)


            if (userId   == '') userId   = txtUserId .value;
            if (tier     == '') tier     = txtTier   .value;
            if (lastDate == '') lastDate = txtLastDate.value;


            let   license = createLicenseFromData(userId, tier, lastDate);
            const key     = createLicenseKey(license);
            

            // const [p, q] = createCryptoPrimePair(65537n);

            // txt += 'p: ' + p + '<br/>';
            // txt += 'q: ' + q + '<br/><br/>';

            txt += 'Request user ID:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + userId + '<br/>';
            txt += 'Request tier:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + license.tier + '<br/>';
            txt += 'Request last date (included): ' + lastDate + '<br/><br/>';

            txt += 'Request string:&nbsp;&nbsp;&nbsp;&nbsp;' + createLicenseString(license) + '<br/><br/>';

            if (   userId   != 'false'
                && tier     != 'false'
                && lastDate != 'false')
                txt += 'License key:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + key + ' ' + getValidSign(license, key) + '<br/>';


            license = validateLicense(userId, key);

            if (license)
            {
                txt += 'License tier:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + license.tier + '<br/>';

                txt += 'License last date: ' 
                           + license.lastDay  .toString().padStart(2, '0') 
                     + '/' + license.lastMonth.toString().padStart(2, '0')
                     + '/' + license.lastYear .toString() + '<br/><br/>';
            }


            for (let i = -3; i <= 3; i++)
            {
                const _key = key.substring(0, key.length-1) + String.fromCharCode(Number(key.charCodeAt(key.length-1))+i);
                txt += '<br/>' + _key + ' ' + (validateLicense(userId, _key) ? '<font color="green">√</font>' : '<font color="red">X</font>');
            }


            text.innerHTML = txt;
        }



        function getValidSign(license, key)
        {
            return !!license
                ? '<font color="green">√</font>' 
                : '<font color="red">X</font>';
        }

    </script>

</html>