<html>
    <script src="core/lib.js"></script>
    <script src="core/math.js"></script>
    <script src="core/util.js"></script>
    <script src="core/random.js"></script>
    <script src="core/base32.js"></script>
    <script src="core/base64.js"></script>
    <script src="core/common.js"></script>
    <script src="core/bigmath.js"></script>
    <script src="license/crypto.js"></script>
    <script src="license/license.js"></script>


    <body>
        <div>User ID  <input type='text' id='txtUserId' spellcheck='false' /></div>
        <div>Tier  <input type='text' id='txtTier' spellcheck='false' /></div>
        <div>Type  <input type='text' id='txtType' spellcheck='false' /></div>
        <div>Subscription start (ddmmyyyy) <input type='text' id='txtSubStart' spellcheck='false' /></div>
        <div>Subscription end   (ddmmyyyy) <input type='text' id='txtSubEnd' spellcheck='false' /></div>
        <div>License start      (ddmmyyyy) <input type='text' id='txtLicStart' spellcheck='false' /></div>
        <div>License end        (ddmmyyyy) <input type='text' id='txtLicEnd' spellcheck='false' /></div>
        <input type='button' onclick='generateLicenseKey()' value='Generate license key' />
        <p id='text' style="margin-top: 30px"></p>
    </body>

    <style>
        body
        {
            font:          11pt Consolas;
            overflow-wrap: break-word;
            word-break:    break-all;
            line-height:   1.5em;
        }
    </style>

    <script>

        function generateLicenseKey()
        {
            let txt = '';


            let userId   = getQueryVariable('userId'  );
            let tier     = getQueryVariable('tier'    );
            let type     = getQueryVariable('type'    );
            let subStart = getQueryVariable('subStart'); // DDMMYYYY (UTC)
            let subEnd   = getQueryVariable('subEnd'  ); // DDMMYYYY (UTC)
            let licStart = getQueryVariable('licStart'); // DDMMYYYY (UTC)
            let licEnd   = getQueryVariable('licEnd'  ); // DDMMYYYY (UTC)


            if (userId == '') userId = txtUserId  .value;
            if (tier   == '') tier   = txtTier    .value;
            if (date   == '') date   = txtLastDate.value;


            let   license = createLicenseFromDate(userId, date, tier);
            const key     = createLicenseKey(license);
            

            // const [p, q] = createCryptoPrimePair(65537n);

            // txt += 'p: ' + p + '<br/>';
            // txt += 'q: ' + q + '<br/><br/>';

            txt += 'Request ID:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + userId + '<br/>';
            txt += 'Request tier:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + license.tier + '<br/>';
            txt += 'Request last date: ' + date     + '<br/><br/>';

            txt += 'Request string:&nbsp;&nbsp;&nbsp;&nbsp;' + createLicenseString(license) + '<br/><br/>';

            if (   userId != 'false'
                && date   != 'false')
                txt += 'License key:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + key + ' ' + getValidSign(license, key) + '<br/>';


            license = validateLicense(userId, key);

            if (license)
            {
                txt += 'License tier:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + license.tier + '<br/>';
                txt += 'License last date: ' + license.lastDay.toString().padStart(2, '0') + '/' + license.lastMonth.toString().padStart(2, '0') + '/' + license.lastYear.toString() + '<br/><br/>';
            }


            for (let i = -3; i <= 3; i++)
            {
                const _key = key.substring(0, key.length-1) + String.fromCharCode(Number(key.charCodeAt(key.length-1))+i);
                txt += '<br/>' + _key + ' ' + (validateLicense(userId, _key) ? '<font color="green">√</font>' : '<font color="red">X</font>');
            }


            text.innerHTML = txt;
        }



        function getValidSign(license, key)
        {
            return !!license
                ? '<font color="green">√</font>' 
                : '<font color="red">X</font>';
        }

    </script>

</html>